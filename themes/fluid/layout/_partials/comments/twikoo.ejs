<% if (theme.twikoo && theme.twikoo.envId) { %>
  <div id="twikoo"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      Fluid.utils.createScript('<%= url_join(theme.static_prefix.twikoo, 'twikoo.all.min.js') %>', function() {
        var options = Object.assign(
          <%- JSON.stringify(theme.twikoo || {}) %>,
          {
            el: '#twikoo',
            path: '<%= theme.twikoo.path %>',
            onCommentLoaded: function() {
              <% if (page.title === "说说") { %>
                var iconNum = document.getElementsByClassName('tk-icon');
                if (iconNum && iconNum.length > 0) {
                  var showItem = document.querySelector('.tk-submit');
                  if (showItem) {
                    showItem.style.display = 'block';
                  }
                };
                var commentContents = document.getElementsByClassName('tk-content');
                for (var i = 0; i < commentContents.length; i++) {
                    var commentItem = commentContents[i];
                    var imgEls = commentItem.getElementsByTagName('img');
                    if (imgEls.length > 0) {
                        for (var j = 0; j < imgEls.length; j++) {
                            var imgEl = imgEls[j];
                            if (imgEl.className != 'tk-owo-emotion' && imgEl.className != 'hasfancybox') {
                              imgEl.setAttribute('class', 'hasfancybox');
                              var aEl = document.createElement('a');
                              aEl.setAttribute('class', 'fancybox fancybox.image');
                              aEl.setAttribute('href', imgEl.getAttribute('src'));
                              aEl.setAttribute('data-fancybox', 'default');
                              aEl.setAttribute('data-options', '{"loop" : "true"}');
                              aEl.setAttribute('rel', 'default');
                              aEl.appendChild(imgEl.cloneNode(false));
                              imgEl.parentNode.insertBefore(aEl, imgEl.nextSibling);
                              imgEl.remove();
                            };
                        };
                    };
                };
              <% } %>
            }
          }
        )
        twikoo.init(options)
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>
<% } %>
